name: Publish Release

on:
  workflow_dispatch:
    inputs:
      release_id:
        description: "Tag name of the draft release to publish (e.g., v0.19.0)"
        required: true

permissions:
  actions: write
  contents: write
  pull-requests: write

jobs:
  publish-release:
    if: github.repository == 'galaxyproject/brc-analytics'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22.12.0"

      - name: Configure git
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

      - name: Get release info
        id: get_release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_ID: ${{ github.event.inputs.release_id }}
        run: |
          RELEASE_TAG=$(gh release view $RELEASE_ID --json tagName -q '.tagName')
          VERSION=${RELEASE_TAG#v}
          echo "tag=$RELEASE_TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Merge main to production
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Fetch all branches
          git fetch origin main production

          # Checkout production and merge main
          git checkout production
          git merge origin/main -m "Release ${{ steps.get_release.outputs.tag }}: merge main to production"

          # Move the release tag to point to this merge commit so git describe
          # shows the correct version (e.g., "v0.21.0" not "v0.21.0-1-gXXX")
          git tag -f ${{ steps.get_release.outputs.tag }}

          # Push production branch and updated tag
          git push origin production
          git push origin ${{ steps.get_release.outputs.tag }} --force

      - name: Trigger production deploy
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # GITHUB_TOKEN pushes don't trigger workflows, so we manually trigger the deploy
          gh workflow run publish.yml --ref production

      - name: Publish release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_ID: ${{ github.event.inputs.release_id }}
        run: |
          gh release edit "$RELEASE_ID" --draft=false

      - name: Bump main to next development version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_VERSION="${{ steps.get_release.outputs.version }}"

          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

          # Always do minor bump: 0.19.0 â†’ 0.20.0
          NEXT_VERSION="${MAJOR}.$((MINOR + 1)).0"

          echo "Bumping from $CURRENT_VERSION to $NEXT_VERSION"

          BRANCH_NAME="release/bump-to-$NEXT_VERSION"

          # Create branch from main
          git checkout main
          git pull origin main
          git checkout -b "$BRANCH_NAME"

          # Update version
          npm version $NEXT_VERSION --no-git-tag-version

          # Commit changes
          git add package.json package-lock.json
          git commit -m "chore: bump version to $NEXT_VERSION for next development cycle [skip ci]"

          # Push branch
          git push -u origin "$BRANCH_NAME"

          # Create PR
          gh pr create \
            --title "chore: bump version to $NEXT_VERSION" \
            --body "Automated version bump after release ${{ steps.get_release.outputs.tag }}.

          - \`production\` branch = ${{ steps.get_release.outputs.version }} (stable)
          - \`main\` branch = $NEXT_VERSION (development)" \
            --head "$BRANCH_NAME" \
            --base main
